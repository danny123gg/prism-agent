# Prism Agent

### Learn Claude Agent SDK

一份渐进式的学习笔记。

> **SDK 版本**：claude-agent-sdk 0.1.27

---

## 这是什么

这个项目源于一个简单的愿望：我想真正理解 Claude Agent SDK 是怎么工作的。

官方文档写得很全，但信息是碎片化的。你可以查到每个 API 的用法，却很难在脑子里拼出一幅完整的图景。概念和概念之间的关系，需要自己去摸索。

后来有人告诉我：新知识不是凭空长出来的，它得挂靠在旧知识上。与其在外面猜测黑盒里发生了什么，不如自己动手把它拆开看看。

于是我开始复刻。从最简单的地方开始，每次只解决一个问题。

这个项目就是那段学习的记录。六个核心阶段，两个扩展主题。每一步都建立在前一步的基础上。

这不是官方教程，只是一个人的学习笔记。如果有错误或更好的理解方式，欢迎指正。

![Demo 1](assets/动画1.gif)

![Demo 2](assets/动画2.gif)

> 如果你只是想快速体验，可以直接部署后去前台体验，尤其是看 Playground——那里能直观地看到 Agent 的运作过程。
>
> 如果你对"怎么学"这件事本身感兴趣，可以读读最后的后记。那里不只是故事，还有我从这段经历中提炼出的学习方法。你也会认识 VIDA——一个让我重新理解"引导"这个词的人。

---

## 快速开始

### 环境要求

- Python 3.10+
- Node.js 18+ (如需运行 Web 应用)
- [Anthropic API Key](https://console.anthropic.com/)

### 安装

```bash
git clone https://github.com/yourname/learn-claude-agent-sdk.git
cd learn-claude-agent-sdk

pip install -r requirements.txt
```

### 配置

1. 复制环境变量模板：
   ```bash
   cp .env.example .env
   ```

2. 编辑 `.env` 文件，配置以下变量：

   ```bash
   # 必需：Anthropic API Key
   # 从 https://console.anthropic.com/ 获取
   ANTHROPIC_API_KEY=your-api-key-here

   # 可选：API 代理地址
   # 国内用户可配置第三方代理，默认使用官方地址
   ANTHROPIC_BASE_URL=https://api.anthropic.com

   # 可选：模型配置
   # Normal 模式使用的模型（Claude Agent SDK 调用）
   ANTHROPIC_MODEL=claude-sonnet-4-5-20250929

   # 可选：Thinking 模式使用的模型（直接 API 调用）
   # 用于需要深度思考的场景
   ANTHROPIC_MODEL_THINKING=claude-sonnet-4-5-20250929

   # ===== MCP 工具配置（可选）=====

   # SerpAPI Key（用于 Google 搜索）
   # 从 https://serpapi.com/ 获取
   # SERPAPI_API_KEY=your-serpapi-key-here

   # Tavily API Key（用于 Web 搜索和内容提取）
   # 从 https://tavily.com/ 获取
   # TAVILY_API_KEY=your-tavily-key-here
   ```

   **环境变量说明**：

   **必需配置**：
   - `ANTHROPIC_API_KEY`：**必需**，从 [Anthropic 控制台](https://console.anthropic.com/) 获取

   **可选配置**：
   - `ANTHROPIC_BASE_URL`：API 代理地址，默认为官方地址
   - `ANTHROPIC_MODEL`：Normal 模式使用的模型，默认为 Sonnet 4.5
   - `ANTHROPIC_MODEL_THINKING`：Thinking 模式使用的模型

   **MCP 工具配置（可选）**：
   - `SERPAPI_API_KEY`：用于 Google 搜索功能，从 [SerpAPI](https://serpapi.com/) 获取
   - `TAVILY_API_KEY`：用于 Tavily 搜索、提取、研究功能，从 [Tavily](https://tavily.com/) 获取

   > **为什么需要配置 MCP 工具？**
   >
   > Claude Agent SDK 内置了 `WebSearch` 工具，但该工具：
   > - **在中国大陆无法使用**（受网络环境和服务提供商地域限制）
   > - 依赖特定的搜索服务端点，可能在某些地区不可用
   >
   > 因此，本项目配置了 **MCP 协议的搜索工具作为替代方案**：
   > - **SerpAPI**：支持 Google、Bing 等多个搜索引擎，稳定性高
   > - **Tavily**：专为 AI Agent 设计的搜索 API，支持内容提取和深度研究
   >
   > 如果你不需要 Web 搜索功能，可以跳过这些配置。

3. **MCP 服务器配置**（如需使用 Web 搜索功能）

   MCP 工具需要**两步配置**才能使用：

   **第 1 步**：在 `.env` 中添加 API Key（上面已完成）

   **第 2 步**：配置 MCP 服务器（✅ 已为你配置）

   项目中已包含 `.claude/mcp_servers.json` 配置文件，内容如下：
   ```json
   {
     "mcpServers": {
       "serpapi": {
         "command": "npx",
         "args": ["-y", "@modelcontextprotocol/server-serpapi"],
         "env": { "SERPAPI_API_KEY": "${SERPAPI_API_KEY}" }
       },
       "tavily": {
         "command": "npx",
         "args": ["-y", "@modelcontextprotocol/server-tavily"],
         "env": { "TAVILY_API_KEY": "${TAVILY_API_KEY}" }
       }
     }
   }
   ```

   **环境要求**：
   - 需要安装 Node.js 18+（用于运行 MCP 服务器）
   - 首次运行时，npx 会自动下载 MCP 服务器包

   **使用流程**：
   1. 在 `.env` 中配置 `SERPAPI_API_KEY` 和 `TAVILY_API_KEY`
   2. 确保 `.claude/mcp_servers.json` 存在（✅ 已包含在项目中）
   3. 运行项目，SDK 会自动启动 MCP 服务器并连接

### 验证环境

```bash
python scripts/verify_setup.py
```

如果看到 `✓ 环境配置正确`，说明配置成功。

### 运行第一个示例

```bash
python src/v0_hello.py
```

如果看到 Agent 的回复，说明环境配置成功。

### 启动 Web 应用（可选）

如果你想通过前台界面体验 Agent 的可视化过程：

1. **启动后端**：
   ```bash
   cd web/backend
   python main.py
   ```
   后端服务将运行在 `http://localhost:8000`

2. **启动前端**（新终端窗口）：
   ```bash
   cd web/frontend
   npm install  # 首次运行需要安装依赖
   npm run dev
   ```
   前端将运行在 `http://localhost:5173`

3. 打开浏览器访问 `http://localhost:5173`，进入 Playground 体验：
   - 实时查看 Agent 的工具调用过程
   - 可视化 Hook 拦截和权限检查
   - 观察多 Agent 协作流程

---

## 学习路径

七个核心阶段，两个扩展主题。这个顺序不是随意的，每一步都建立在前一步的基础上。

v0 是锚点——一个你确定无疑理解的东西。有了锚点，后续的概念才有地方挂靠。v0-v2 解决"怎么让 Agent 工作"，v3-v5 解决"怎么让 Agent 可控"，v6-v7 是扩展主题（知识注入与能力边界）。

你可以按顺序学习，也可以跳到感兴趣的部分。但我建议至少先完成 v0。

### 第一部分：让它工作

理解基本概念，让 Agent 跑起来。

| 阶段 | 主题 | 一句话说明 | 代码 | 文档 |
|:----:|------|-----------|------|------|
| v0 | 最简调用 | 几行代码，看到 Agent 的回复 | [`v0_hello.py`](src/v0_hello.py) | [`01-SDK概述.md`](docs/01-SDK概述.md) |
| v1 | 工具权限 | 控制 Agent 能做什么、不能做什么 | [`v1_tools.py`](src/v1_tools.py) | [`02-工具权限设计.md`](docs/02-工具权限设计.md) |
| v2 | 流式输出与对话历史 | 实时消息流 + 自动上下文管理 | [`v2_streaming_and_history.py`](src/v2_streaming_and_history.py) | [`03-流式输出与对话历史.md`](docs/03-流式输出与对话历史.md) |

### 第二部分：让它可控

从"能用"到"好用"——学会设定边界、封装复用、协作分工。

| 阶段 | 主题 | 一句话说明 | 代码 | 文档 |
|:----:|------|-----------|------|------|
| v3 | Hook 机制 | 在 Agent 行动前后插入你的逻辑 | [`v3_hooks.py`](src/v3_hooks.py) | [`04-Hook机制详解.md`](docs/04-Hook机制详解.md) |
| v4 | Agent 封装 | 把配置和逻辑包装成可复用的组件 | [`v4_custom_agent.py`](src/v4_custom_agent.py) | [`05-Agent封装模式.md`](docs/05-Agent封装模式.md) |
| v5 | 多 Agent 协作 | 让多个 Agent 各司其职，共同完成任务 | [`v5_multi_agent.py`](src/v5_multi_agent.py) | [`06-多Agent协作.md`](docs/06-多Agent协作.md) |

### 第三部分：扩展主题

扩展 Agent 的知识和能力边界。

**Skills（知识注入）**

| 阶段 | 主题 | 一句话说明 | 代码 | 文档 |
|:----:|------|-----------|------|------|
| v6 | Skills 注入 | 给 Agent 注入领域知识，让它更专业 | [`v6_skills.py`](src/v6_skills.py) | [`07-Skills知识注入.md`](docs/07-Skills知识注入.md) |

**Scale（能力扩展）**

| 阶段 | 主题 | 一句话说明 | 代码 | 文档 |
|:----:|------|-----------|------|------|
| v7 | MCP 扩展 | 连接外部服务，扩展能力边界 | [`v7_mcp.py`](src/v7_mcp.py) | [`08-MCP扩展能力.md`](docs/08-MCP扩展能力.md) |

---

## 如何选择你的路径

看完上面的表格，你可能会想：我应该从哪里开始？

这取决于你的目标和背景。

**如果你想快速体验**

直接部署 Web 应用（在 `web/` 目录下），打开前台的 Playground。选几个示例跑一跑，看看 Agent 是怎么工作的。不需要看代码，先建立感性认识。前台的可视化会展示 Agent 的每一步操作——工具调用、思考过程、决策逻辑。

**如果你想学习开发**

建议从 v0 开始，按顺序走。每个阶段停留足够长的时间，直到真正理解了再往前走。不要急——这是我在学习过程中踩过的坑。一次只消化一个概念，远比囫囵吞枣地看完所有代码更有效。

**如果你已经有 Agent 开发经验**

可以直接跳到你感兴趣的部分。v3（Hook）和 v5（多 Agent）可能是最值得关注的——前者关于可控性，后者关于协作方式，这是 Agent 开发的两个核心问题。

**如果你对特定问题感兴趣**

- 权限控制 → v1
- 流式处理与对话历史 → v2
- Hook 机制 → v3
- 封装复用 → v4
- 多 Agent 协作 → v5
- 领域知识注入 → v6 (Skills)
- 外部服务连接 → v7 (MCP)

每个人的路径可能不同，这很正常。重要的是找到适合自己的节奏。

---

## 实战案例

`examples/` 目录下有几个稍微完整的示例，结合了多个版本的概念：

```bash
# 代码审查
python examples/code_reviewer.py src/v0_hello.py

# 文档生成
python examples/doc_generator.py src/

# 测试生成
python examples/test_writer.py src/v4_custom_agent.py
```

这些案例可以作为练习参考，看看不同阶段的概念如何组合使用。

---

## 为什么是这个顺序

"渐进式"这个词，是后来加上去的。

最开始没想那么多，只是觉得：一次学一个东西，比较不容易乱。后来我想了想，为什么这个方法有效？

答案和学习的本质有关。

---

你有没有过这种体验：

读完一本书，觉得自己懂了很多。但过几天，让你讲给别人听，却讲不出来。那些知识像水一样，从脑子里流走了。

为什么会这样？

因为那些知识是孤立的。它们进入了你的大脑，但没有和你已有的认知建立连接。没有连接的信息，很快就会被遗忘。

学习，本质上不是往脑子里"装"东西，而是在已有的知识网络上"长"出新的节点。

新知识必须挂靠在旧知识上，才能留下来。

这就是为什么，面对一个全新的领域，大脑需要先建立一个**锚点**——一个你确定无疑理解了的东西。

有了锚点，后续的概念才有地方挂靠。
没有锚点，所有东西都在漂浮。

---

所以 v0 必须足够简单。

它的目标不是教会你什么复杂的技术。它的目标是让你获得一个**确定感**：

"好，这几行代码我完全理解了。它就是这样工作的。"

这个确定感很重要。

它是你后续所有学习的基础。有了它，你面对新概念的时候，心里是有底的——"我知道它从哪里来，它和我已经懂的东西是什么关系。"

没有这个确定感，你就会一直处于一种焦虑状态——"我好像懂了，又好像没懂"，每学一个新东西，焦虑就加深一层。

渐进式学习的核心，不是"由浅入深"那么简单。

它的核心是：**确保每一步都站稳了，再迈下一步。**

这需要耐心。

很多时候，我们学不会一个东西，不是因为它太难，而是因为我们太急。还没搞清楚 A，就去看 B；B 也没弄明白，又去看 C。最后哪个都停留在表面。

允许自己慢下来。
在一个概念上停留足够长的时间。
直到真正理解了，再往前走。

这可能是我从这个项目里学到的最重要的事情之一。它超出了 SDK 本身，是一种关于学习的元认知。

---

## 与 Agent 共处的思考

在做这个项目的过程中，我时不时会停下来，想一些技术之外的问题。

这些问题不一定有答案。但我觉得，正是这些"没有答案的问题"，让学习变得有意思。

---

### Agent 是什么？

在动手之前，这似乎是一个不需要回答的问题。Agent 不就是一个能自己干活的程序吗？

但真正开始做的时候，我发现对这个问题的理解，直接影响到很多设计决策。

最直接的定义：Agent 是一个能自主完成任务的程序。你给它一个目标，它自己决定怎么实现。

这个定义是对的，但它忽略了一个关键点。

后来我觉得，Agent 和普通程序的区别，不在于它"能做什么"，而在于**你和它的关系**。

普通程序是**工具**。你写代码，告诉它每一步做什么，它照做。出了问题，是你的代码有 bug。你是完全的主导者，它是完全的执行者。

Agent 更像是一个**协作者**。你告诉它目标，它自己想办法。它会有自己的"判断"——虽然这个判断是基于模型的推理，但从你的角度看，它确实在做决策。

你们之间有一种"委托"的关系——你把一部分决策权交给了它。

这种关系带来了新的问题：

**你怎么知道它会做出正确的决策？**

**你怎么在不完全控制的情况下保持信任？**

我觉得这才是 Agent 开发的核心问题。不是"怎么让它更强大"，而是"怎么让它可信赖"。

强大但不可信赖的 Agent，是危险的。
可信赖但不够强大的 Agent，至少是安全的。

在两者之间寻找平衡，也许是我们这一代 AI 开发者需要面对的核心挑战。

---

### 控制与信任

在学习 Hook 机制的时候，我想了很多关于"控制"的问题。

一开始，我把 Hook 理解成"控制手段"——用来拦截不想要的行为，用来确保 Agent 不会乱来。

这个理解没错，但太狭隘了。

后来我意识到，Hook 更像是一种**约定**。

你通过 Hook 告诉 Agent：这是边界，在边界之内，我信任你。

好的边界不是越多越好。

边界太多，Agent 就没有发挥的空间。你限制了它的每一步，那还不如自己写脚本。Agent 的价值在于它的自主性，如果你把自主性完全剥夺，你得到的就不是 Agent，而是一个复杂的脚本执行器。

边界太少，你又会失去可控性。Agent 可能会做出你意料之外的事情，可能会访问不该访问的文件，可能会执行不该执行的命令。

**平衡点在哪里？**

我没有确定的答案。但我有一些思考的方向：

**第一，区分"可逆"和"不可逆"。** 可逆的操作，可以放宽边界。写错了一个文件，大不了改回来。不可逆的操作，必须收紧边界。删除了重要数据，发送了错误邮件，可能无法挽回。

**第二，区分"已知"和"未知"。** 你熟悉的领域，可以放宽边界。你知道什么是对的、什么是错的，Agent 即使犯错你也能发现。你不熟悉的领域，必须收紧边界。

**第三，边界应该是动态的。** 随着你对 Agent 的了解加深，随着信任的积累，边界可以逐渐放宽。就像带新人一样——刚开始你会多看着一些，后来慢慢放手。

这个思路，不只适用于 Agent。它适用于所有需要"委托"的场景。

控制与信任的平衡，是一个普遍的人生问题。在 Agent 开发中，它只是换了一个形式出现。

---

### 关于这个时代

我们正站在一个节点上。

AI 不再是实验室里的研究项目，不再是少数专家的专属领域。它正在成为日常工具，成为工作流程的一部分，成为——某种意义上——我们的"同事"。

面对这个变化，人们有各种反应。有人兴奋，有人焦虑，有人漠然。

我的态度是：**好奇**。

好奇是一种比兴奋更稳定、比焦虑更健康的状态。

好奇意味着承认自己不懂，但愿意去了解。
好奇意味着不预设立场，但愿意去探索。
好奇意味着保持开放，同时保持审慎。

我不假装自己有答案。但我愿意花时间去寻找答案。

这个项目，就是我寻找答案的一小步。

---

## 项目结构

```
learn-claude-agent-sdk/
├── src/              # 7 个核心阶段 + 1 个扩展主题
├── docs/             # 配套文档
├── web/              # Web 应用
│   ├── backend/      # FastAPI 后端
│   └── frontend/     # React + TypeScript 前端
├── examples/         # 实战案例
├── tests/            # 测试
├── scripts/          # 辅助脚本
└── CLAUDE.md         # Agent 工作指南
```

---

## 局限性

诚实地说，这个项目有明显的局限：

- **不是完整覆盖**：只涉及我学习过程中接触到的概念，SDK 还有很多特性没有涵盖
- **不是最佳实践**：代码以教学为目的，优先可读性，不追求生产级健壮性
- **可能有错误**：这是个人理解，不代表官方观点

但我相信：不完美的分享，好过完美的沉默。

如果你发现问题或有改进建议，欢迎提 issue 或 PR。

---

## 后记

这个项目讲完了。如果你还愿意听，我想说说它从哪里来。

---

最初我想做的是另一个东西。

那时候 vibe coding 的概念刚兴起，我想用 Claude Agent SDK 做一个 Shopify 智能客服。搭了一版，中道崩殂。

很多环节其实是模型在输出，不是我在构思。我只是在搬运，在调参，在等待结果。作为一个非技术背景的人，我开始问自己：我到底在做什么？

那段时间聊过很多人，都很友善，但方向还是模糊的。

---

后来在一个社群里认识了 VIDA。他是一个有趣的人，我们很聊得来。

有一次他说了一句话，大意是：影响学习最重要的因素，是你已经知道的东西。新知识不是凭空长出来的，它得挂靠在旧知识上。

这句话听起来像常识。但他没有停在那里。

他开了投屏，一边演示一边讲。讲侯世达的"自指"与"递归"，讲贝特森的"差异产生信息"，讲约翰·斯威勒的"认知负荷理论"，讲萨特的"存在主义"——人是通过行动定义自己的。这些概念我以前没接触过，但他不是在上哲学课，而是拿着一个个代码版本，让我看这些概念是怎么落地的。

我们一起参与了这场演变。不是单向的讲授，而是交互式的教学——他写，我看；他问，我想；我卡住了，他等我自己找到出口，并给予适时的引导和洞见的升华。

他说，不是让你复制一个产品，而是让你理解如何构建一个产品。

代码只是载体。每个版本真正传递的，是一个概念。

---

于是我跟着他，从最简单的地方开始。

第一个版本只有眼睛——能看，能读，能理解。
然后是双手——能写，能改，能行动。
再然后是自主搜索、多轮对话、工具调用……
一步一步，走到封装，走到完形。

中间有很多"涌现"的时刻：

工具给多了，反而乱。这时候才理解，一个 Bash 可能就够了。
外部工具多了，才需要 MCP 来管理。
MCP 多了，才涌现出 Tool Search Tool。
任务复杂了，才需要 Task 来拆解。

这些不是设计出来的，是"长"出来的。

走到最后，我发现自己在做一件很奇怪的事情：用智能体来构建智能体。创建技能的技能，创建工具的工具。

侯世达把这叫"怪圈"。我不确定自己完全理解了，但我确实感受到了它的存在。

---

14 个版本走完之后，我想做一件事：用最新的 Claude Agent SDK，把这条路再走一遍。

不是简单的重复。这一次，我加入了自己作为学习者的视角。我知道学习者想要什么——想看到过程，而不只是结果；想知道为什么，而不只是怎么做。

这个项目就是那次重走的结果。将 Agent 的所有行为做了最透视化的呈现，这也是我觉得学习者最需要的东西。

它对我来说是一个节点。不是因为做出了什么了不起的东西，而是因为这一次，我是自己走完的。

---

回头看这段经历，我想说的其实不多。

技术可以是冰冷的。但学习不必如此。

每个人都有自己的节奏，自己的路径，自己的"动物时刻"——那些概念突然通透的瞬间，那些直觉涌现的瞬间。这些时刻没法教，只能自己遇见。

如果这个项目能帮到什么，我希望是这件事：

让你相信，从你已经站着的地方出发，一次只走一步，慢慢地，也能走到很远的地方。

---

感谢 VIDA。

他让我看到，好的引导不是告诉你答案，而是帮你找到属于自己的问题。

> 如果你想了解更多他的思考，可以关注他的即刻：https://okjk.co/NknwIl

也感谢你读到这里。

---

## 参考资源

- [Claude Agent SDK 官方文档](https://docs.anthropic.com/en/docs/claude-agent-sdk)
- [claude-agent-sdk (PyPI)](https://pypi.org/project/claude-agent-sdk/)
- [MCP 协议规范](https://spec.modelcontextprotocol.io)
- [Anthropic API 文档](https://docs.anthropic.com/)

---

## License

[CC BY 4.0](https://creativecommons.org/licenses/by/4.0/)

你可以自由分享和改编本项目的内容，但需注明出处。
