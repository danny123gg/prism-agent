# 02 - 工具权限设计

> 配套代码：`src/v1_tools.py`
>
> **目标**：理解最小权限原则，学会控制 Agent 的能力边界

---

## 为什么要谈权限？

在 v0 中，我们用了 `bypassPermissions`，跳过了所有权限检查。这让学习变得简单，但也留下了一个隐患。

Claude Agent SDK 内置了一些强大的工具：

- **Bash** — 执行系统命令
- **Read** — 读取任意文件
- **Write** — 创建和覆盖文件
- **Edit** — 修改文件内容

这些工具很强大。但"强大"是一把双刃剑。

一个没有权限控制的 Agent，理论上可以读取你的敏感配置、删除重要文件、执行危险命令。在学习环境里这没什么，但如果你要把 Agent 用在任何正式场景——哪怕只是给同事演示——这是不可接受的风险。

**权限控制不是可选项，而是必须从一开始就建立的意识。**

---

## 三个层次的控制

SDK 提供了三个层次的权限控制。你可以组合使用它们。

### 第一层：工具白名单

最直接的方式：只允许使用指定的工具。

```python
options = ClaudeAgentOptions(
    allowed_tools=["Read"]  # 只能读，不能写
)
```

Agent 不会"看到"未授权的工具。它不会尝试使用它们，因为它根本不知道它们存在。

### 第二层：权限模式

SDK 提供了几种权限模式，控制工具执行时的确认行为：

| 模式 | 行为 | 适用场景 |
|------|------|----------|
| `default` | 敏感操作需要用户确认 | 生产环境 |
| `acceptEdits` | 文件编辑自动执行，其他敏感操作仍需确认 | 开发环境 |
| `bypassPermissions` | 跳过所有检查 | 仅用于沙箱/测试 |

```python
# 生产环境
options = ClaudeAgentOptions(permission_mode="default")

# 开发环境
options = ClaudeAgentOptions(permission_mode="acceptEdits")

# 测试环境（谨慎使用）
options = ClaudeAgentOptions(permission_mode="bypassPermissions")
```

### 第三层：Hook 拦截

这是最精细的控制方式。你可以在每次工具调用前后插入自己的逻辑，检查参数、记录日志、甚至拦截操作。

这部分内容较多，我们在 [04-Hook机制详解](./04-Hook机制详解.md) 中专门讨论。

---

## 常用工具一览

SDK 内置了这些工具：

| 工具 | 功能 | 风险级别 |
|------|------|----------|
| `Read` | 读取文件 | 低 |
| `Glob` | 搜索文件（按模式匹配） | 低 |
| `Grep` | 搜索内容 | 低 |
| `Write` | 创建或覆盖文件 | 中 |
| `Edit` | 编辑现有文件 | 中 |
| `Bash` | 执行命令 | **高** |
| `Task` | 启动子 Agent | 中 |

**一个建议**：根据任务需求选择最小的工具集。

- 代码审查 → `Read`, `Glob`, `Grep`（只读）
- 文档生成 → `Read`, `Write`
- 代码修改 → `Read`, `Edit`, `Write`
- 全功能 → 不限制（但要三思）

---

## v1 代码示例

让我们看看不同权限配置的效果。

```python
async def run_with_tools(name: str, allowed_tools: list[str], prompt: str):
    options = ClaudeAgentOptions(
        model="sonnet",
        permission_mode="bypassPermissions",
        allowed_tools=allowed_tools,  # 关键：工具白名单
    )

    async with ClaudeSDKClient(options=options) as client:
        await client.query(prompt=prompt)
        # ... 处理响应
```

### 只读模式

```python
await run_with_tools(
    name="Read-Only",
    allowed_tools=["Read"],
    prompt="Read the file requirements.txt and summarize it."
)
```

Agent 可以读取文件，但无法创建或修改任何东西。

### 读写模式

```python
await run_with_tools(
    name="Read-Write",
    allowed_tools=["Read", "Write"],
    prompt="Create a file called 'hello.txt' with content 'Hello World'."
)
```

Agent 可以读取和创建文件。

### 纯对话模式

```python
await run_with_tools(
    name="No Tools",
    allowed_tools=[],
    prompt="What is 2 + 2?"
)
```

Agent 无法使用任何工具，只能纯对话。这种模式费用最低，因为不涉及工具调用。

---

## 运行示例

```bash
python src/v1_tools.py
```

你会看到三种模式的对比：

```
==================================================
Mode: Read-Only
Allowed tools: ['Read']
--------------------------------------------------
[Tool: Read]
The requirements.txt file lists the following dependencies...
[Cost: $0.0201]

==================================================
Mode: Read-Write
Allowed tools: ['Read', 'Write']
--------------------------------------------------
[Tool: Write]
Done! I've created the file test_output.txt...
[Cost: $0.0188]

==================================================
Mode: No Tools (Conversation Only)
Allowed tools: []
--------------------------------------------------
2 + 2 = 4
[Cost: $0.0087]
```

观察费用的差异。无工具模式最便宜，因为不需要处理工具调用的额外 token。

---

## 最佳实践

### 默认最小权限

```python
# 好：明确指定需要的工具
allowed_tools=["Read", "Glob"]

# 差：不限制
allowed_tools=None  # 或者干脆不设置
```

除非你有明确的理由，否则总是限制工具权限。

### 按任务分配权限

不同的任务，给不同的权限：

```python
# 审查任务：只读
review_options = ClaudeAgentOptions(allowed_tools=["Read", "Glob", "Grep"])

# 修改任务：读写
edit_options = ClaudeAgentOptions(allowed_tools=["Read", "Edit"])
```

### 记录工具使用

养成习惯，记录 Agent 使用了什么工具：

```python
if block_type == 'ToolUseBlock':
    print(f"[Tool: {block.name}]")
```

这对调试和审计都很有帮助。

---

## 一些问题

**Q: 如果 Agent 尝试使用未授权的工具会怎样？**

它不会尝试。SDK 在配置时就过滤了工具列表，Agent 看不到未授权的工具。

**Q: `allowed_tools=[]` 和不设置有什么区别？**

- `allowed_tools=[]` — 明确禁止所有工具
- 不设置 — 使用默认工具集（可能包含危险工具）

**Q: 可以动态修改权限吗？**

不能。每次创建 `ClaudeSDKClient` 时确定权限。如果需要不同权限，创建新的客户端实例。

---

## 小结

这一节的核心是一个意识：**权限控制要从一开始就考虑**。

技术上很简单，就是配置 `allowed_tools`。但重要的是养成这个习惯——每次创建 Agent 时，问自己：它真的需要这些权限吗？

这个意识会在后面的学习中越来越重要。特别是当我们开始讨论 Hook 和多 Agent 系统的时候。

---

## 下一步

在 [03-流式处理详解](./03-流式处理详解.md) 中，我们会解决另一个问题：如何"看到" Agent 的工作过程。
