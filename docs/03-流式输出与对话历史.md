# 03 - æµå¼è¾“å‡ºä¸å¯¹è¯å†å²

> é…å¥—ä»£ç ï¼š`src/v2_streaming_and_history.py`
>
> **ç›®æ ‡**ï¼šç†è§£ Claude Agent SDK çš„ä¸¤ä¸ªæ ¸å¿ƒç‰¹æ€§ï¼šå®æ—¶æ¶ˆæ¯æµå’Œè‡ªåŠ¨ä¸Šä¸‹æ–‡ç®¡ç†

---

## ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µ

### 1. Streamingï¼ˆæµå¼è¾“å‡ºï¼‰

**å®˜æ–¹å®šä¹‰**ï¼ˆåŸºäº claude-agent-sdk 0.1.27 æºç  client.py:347-386ï¼‰ï¼š

```python
async def receive_response(self) -> AsyncIterator[Message]:
    """
    Receive messages from Claude until and including a ResultMessage.

    This async iterator yields all messages in sequence and automatically
    terminates after yielding a ResultMessage.

    Yields:
        Message: Each message received (UserMessage, AssistantMessage,
                 SystemMessage, ResultMessage)
    """
```

**å‡†ç¡®ç†è§£**ï¼š
- âœ… **å¼‚æ­¥æ¶ˆæ¯è¿­ä»£å™¨** - é€ä¸ªæ¥æ”¶å¹¶ yield Message å¯¹è±¡
- âœ… **äº‹ä»¶é©±åŠ¨æ¨¡å¼** - æ¯ä¸ªæ¶ˆæ¯åˆ°è¾¾æ—¶ç«‹å³å¤„ç†
- âœ… **æ¶ˆæ¯ç±»å‹**ï¼š`AssistantMessage`ï¼ˆæ–‡æœ¬+å·¥å…·è°ƒç”¨ï¼‰ã€`ToolResultMessage`ã€`SystemMessage`ã€`ResultMessage`
- âŒ **ä¸æ˜¯**é€ token æµå¼ï¼ˆé‚£æ˜¯åº•å±‚ Anthropic API çš„ streamingï¼‰

### 2. Conversation Historyï¼ˆå¯¹è¯å†å²ï¼‰

**å®˜æ–¹å®šä¹‰**ï¼ˆåŸºäº claude-agent-sdk 0.1.27 æºç  client.py:14-53ï¼‰ï¼š

```python
class ClaudeSDKClient:
    """
    Client for bidirectional, interactive conversations with Claude.

    Key features:
    - **Stateful**: Maintains conversation context across messages
    - **Interactive**: Send follow-ups based on responses
    - **Multi-turn conversations with context**
    """
```

**å‡†ç¡®ç†è§£**ï¼š
- âœ… **Statefulï¼ˆæœ‰çŠ¶æ€ï¼‰** - SDK å†…éƒ¨è‡ªåŠ¨ç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡
- âœ… **æ— éœ€æ‰‹åŠ¨ç®¡ç†** - ä¸éœ€è¦ä¼ é€’ `messages` å‚æ•°
- âœ… **æŒç»­è°ƒç”¨ `query()`** - æ¯æ¬¡è°ƒç”¨è‡ªåŠ¨åŒ…å«ä¹‹å‰çš„ä¸Šä¸‹æ–‡
- âŒ SDK **æ²¡æœ‰** `messages` å‚æ•°

---

## ä¸ºä»€ä¹ˆéœ€è¦æµå¼å¤„ç†ï¼Ÿ

åœ¨ v0 å’Œ v1 ä¸­ï¼Œä»£ç æœ‰ä¸€ä¸ªå…±åŒçš„é—®é¢˜ï¼šä½ çœ‹ä¸åˆ° Agent åœ¨åšä»€ä¹ˆã€‚

ä½ ç»™å®ƒä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åç­‰ç€ã€‚ç­‰å¤šä¹…ï¼Ÿä¸çŸ¥é“ã€‚å®ƒåœ¨å¹²å˜›ï¼Ÿä¸çŸ¥é“ã€‚å¡ä½äº†è¿˜æ˜¯åœ¨æ­£å¸¸å·¥ä½œï¼Ÿä¸çŸ¥é“ã€‚

æµå¼å¤„ç†è§£å†³çš„å°±æ˜¯è¿™ä¸ªé—®é¢˜ã€‚å®ƒè®©ä½ èƒ½"çœ‹åˆ°" Agent çš„å·¥ä½œè¿‡ç¨‹ï¼šå®ƒåœ¨æ€è€ƒä»€ä¹ˆï¼Œè°ƒç”¨äº†ä»€ä¹ˆå·¥å…·ï¼Œå¾—åˆ°äº†ä»€ä¹ˆç»“æœã€‚

---

## æ¶ˆæ¯æµçš„ç»“æ„

SDK è¿”å›çš„æ˜¯ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯æµï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Message Stream                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SystemMessage â†’ AssistantMessage â†’ ToolResultMessage   â”‚
â”‚                       â†“                                  â”‚
â”‚              [TextBlock, ToolUseBlock]                  â”‚
â”‚                       â†“                                  â”‚
â”‚               ... (å¤šè½®å¾ªç¯) ...                         â”‚
â”‚                       â†“                                  â”‚
â”‚                 ResultMessage                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆæ¯ç±»å‹

| ç±»å‹ | è¯´æ˜ | ä½ ä¼šåœ¨é‡Œé¢çœ‹åˆ°ä»€ä¹ˆ |
|------|------|-------------------|
| `AssistantMessage` | Claude çš„å“åº” | æ–‡æœ¬ã€å·¥å…·è°ƒç”¨ |
| `ToolResultMessage` | å·¥å…·æ‰§è¡Œç»“æœ | å·¥å…·è¿”å›çš„å†…å®¹ |
| `SystemMessage` | ç³»ç»Ÿæ¶ˆæ¯ | é…ç½®ä¿¡æ¯ |
| `ResultMessage` | ä¼šè¯ç»“æŸ | è´¹ç”¨ã€ç»Ÿè®¡ä¿¡æ¯ |

### å†…å®¹å—

æ¯ä¸ª `AssistantMessage` çš„ `content` æ˜¯ä¸€ä¸ªå—åˆ—è¡¨ï¼š

- **TextBlock** â€” æ–‡æœ¬å†…å®¹ï¼Œé€šè¿‡ `block.text` è·å–
- **ToolUseBlock** â€” å·¥å…·è°ƒç”¨ï¼ŒåŒ…å« `name`ã€`id`ã€`input`

---

## åŸºæœ¬çš„æµå¼å¤„ç†

```python
from claude_agent_sdk import ClaudeSDKClient, ClaudeAgentOptions

options = ClaudeAgentOptions(
    model="sonnet",
    permission_mode="bypassPermissions",
)

async with ClaudeSDKClient(options=options) as client:
    await client.query("List Python files in src/")

    # Streaming: receive messages one by one
    async for msg in client.receive_response():
        msg_type = type(msg).__name__

        if msg_type == 'AssistantMessage':
            for block in msg.content:
                block_type = type(block).__name__

                if block_type == 'TextBlock':
                    # å®æ—¶è¾“å‡ºæ–‡æœ¬
                    print(block.text, end="", flush=True)

                elif block_type == 'ToolUseBlock':
                    # æ˜¾ç¤ºå·¥å…·è°ƒç”¨
                    print(f"\n[Tool: {block.name}]")

        elif msg_type == 'ResultMessage':
            # ä¼šè¯ç»“æŸ
            print(f"\n[Cost: ${msg.total_cost_usd:.4f}]")
```

å…³é”®ç‚¹ï¼š
- `end=""` â€” ä¸æ¢è¡Œï¼Œè®©æ–‡æœ¬è¿ç»­è¾“å‡º
- `flush=True` â€” ç«‹å³åˆ·æ–°ç¼“å†²åŒºï¼Œå®ç°çœŸæ­£çš„"å®æ—¶"

---

## è‡ªåŠ¨å¯¹è¯å†å²ç®¡ç†

### Claude Agent SDK vs Anthropic API

**é‡è¦åŒºåˆ«**ï¼š

| ç‰¹æ€§ | Claude Agent SDK | Anthropic API |
|------|-----------------|---------------|
| çŠ¶æ€ç®¡ç† | âœ… Statefulï¼ˆè‡ªåŠ¨ï¼‰ | âŒ Statelessï¼ˆæ‰‹åŠ¨ï¼‰ |
| å†å²ç®¡ç† | SDK å†…éƒ¨ç»´æŠ¤ | éœ€è¦æ‰‹åŠ¨ä¼ é€’ `messages` |
| ä»£ç å¤æ‚åº¦ | ç®€å• | éœ€è¦ç®¡ç†å†å²åˆ—è¡¨ |

### ä½¿ç”¨ Claude Agent SDK çš„å¤šè½®å¯¹è¯

```python
async with ClaudeSDKClient(options=options) as client:
    # Turn 1
    await client.query("My name is Alice")
    async for msg in client.receive_response():
        # å¤„ç†å“åº”...
        pass

    # Turn 2 - SDK è‡ªåŠ¨è®°ä½ä¹‹å‰çš„ä¸Šä¸‹æ–‡ï¼
    await client.query("What is my name?")
    async for msg in client.receive_response():
        # âœ… ä¼šæ­£ç¡®å›ç­” "Alice"
        pass
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä¸éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ `messages` åˆ—è¡¨
- âœ… ä¸éœ€è¦ä¼ é€’å†å²å‚æ•°
- âœ… SDK è‡ªåŠ¨å¤„ç†æ‰€æœ‰ä¸Šä¸‹æ–‡

### å¯¹æ¯”ï¼šå¦‚æœä½¿ç”¨ Anthropic APIï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰

```python
from anthropic import Anthropic

client = Anthropic()
messages = []  # â† éœ€è¦æ‰‹åŠ¨ç»´æŠ¤

# Turn 1
messages.append({"role": "user", "content": "My name is Alice"})
response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=1024,
    messages=messages  # â† éœ€è¦æ‰‹åŠ¨ä¼ é€’
)
messages.append({"role": "assistant", "content": response.content[0].text})

# Turn 2
messages.append({"role": "user", "content": "What is my name?"})
response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=1024,
    messages=messages  # â† å†æ¬¡æ‰‹åŠ¨ä¼ é€’
)
```

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Claude Agent SDK æ›´é€‚åˆ Agent åœºæ™¯** - å®ƒä¸ºå¤šè½®äº¤äº’è€Œè®¾è®¡ã€‚

---

## ç»„åˆä½¿ç”¨ï¼šæµå¼ + å¤šè½®å¯¹è¯

å®Œæ•´çš„ä½¿ç”¨æ¨¡å¼ï¼š

```python
async with ClaudeSDKClient(options=options) as client:
    # Turn 1: åˆå§‹è¯·æ±‚
    print("ğŸ‘¤ Turn 1: List all Python files")
    await client.query("List all Python files in src/")

    print("ğŸ¤– Assistant: ", end="")
    async for msg in client.receive_response():
        if type(msg).__name__ == 'AssistantMessage':
            for block in msg.content:
                if type(block).__name__ == 'TextBlock':
                    print(block.text, end="", flush=True)  # æµå¼è¾“å‡º

    print("\n\n---\n")

    # Turn 2: è¿½é—®ï¼ˆSDK è®°ä½äº†ä¹‹å‰çš„ä¸Šä¸‹æ–‡ï¼‰
    print("ğŸ‘¤ Turn 2: How many files did you find?")
    await client.query("How many files did you find?")

    print("ğŸ¤– Assistant: ", end="")
    async for msg in client.receive_response():
        if type(msg).__name__ == 'AssistantMessage':
            for block in msg.content:
                if type(block).__name__ == 'TextBlock':
                    print(block.text, end="", flush=True)
```

**æ•ˆæœ**ï¼š
- âœ… å®æ—¶çœ‹åˆ°æ¯ä¸ªå›å¤çš„ç”Ÿæˆè¿‡ç¨‹ï¼ˆæµå¼ï¼‰
- âœ… Agent è®°ä½ä¹‹å‰è¯´è¿‡çš„è¯ï¼ˆå¤šè½®ï¼‰
- âœ… é›¶æ‰‹åŠ¨å†å²ç®¡ç†ä»£ç 

---

## è¿è¡Œç¤ºä¾‹

```bash
python src/v2_streaming_and_history.py
```

ä½ ä¼šçœ‹åˆ°ä¸‰ä¸ªæ¼”ç¤ºï¼š

1. **Demo 1: Streaming**
   - å±•ç¤ºæ¶ˆæ¯æµçš„ç»“æ„
   - å®æ—¶æ˜¾ç¤ºå·¥å…·è°ƒç”¨å’Œæ–‡æœ¬è¾“å‡º

2. **Demo 2: Multi-turn Conversation**
   - æ¼”ç¤ºè‡ªåŠ¨ä¸Šä¸‹æ–‡ç®¡ç†
   - 3 è½®å¯¹è¯æ— éœ€æ‰‹åŠ¨å†å²ç®¡ç†

3. **Demo 3: Combined Pattern**
   - æµå¼è¾“å‡º + å¤šè½®å¯¹è¯
   - ç”Ÿäº§ç¯å¢ƒçš„å®Œæ•´æ¨¡å¼

---

## è®¾è®¡æ¨¡å¼

### æ¨¡å¼ 1ï¼šåªå…³å¿ƒæ–‡æœ¬

æœ€ç®€å•çš„æƒ…å†µï¼Œä½ åªæƒ³çœ‹åˆ° Claude è¯´äº†ä»€ä¹ˆï¼š

```python
async for msg in client.receive_response():
    if type(msg).__name__ == 'AssistantMessage':
        for block in msg.content:
            if type(block).__name__ == 'TextBlock':
                print(block.text, end="")
```

é€‚åˆï¼šç®€å•å¯¹è¯ï¼Œä¸å…³å¿ƒå·¥å…·è°ƒç”¨ç»†èŠ‚ã€‚

### æ¨¡å¼ 2ï¼šå·¥å…·æ„ŸçŸ¥

ä½ æƒ³çŸ¥é“ Agent æ­£åœ¨ä½¿ç”¨ä»€ä¹ˆå·¥å…·ï¼š

```python
async for msg in client.receive_response():
    if type(msg).__name__ == 'AssistantMessage':
        for block in msg.content:
            if type(block).__name__ == 'TextBlock':
                print(block.text, end="")
            elif type(block).__name__ == 'ToolUseBlock':
                print(f"\n[Using {block.name}...]")
```

é€‚åˆï¼šéœ€è¦äº†è§£ Agent çš„å·¥ä½œè¿›åº¦ã€‚

### æ¨¡å¼ 3ï¼šå®Œæ•´æ—¥å¿—

è®°å½•æ‰€æœ‰äº‹ä»¶ï¼Œç”¨äºè°ƒè¯•æˆ–å®¡è®¡ï¼š

```python
import json
from datetime import datetime

async for msg in client.receive_response():
    msg_type = type(msg).__name__
    timestamp = datetime.now().isoformat()

    log_entry = {
        "time": timestamp,
        "type": msg_type,
        "content": str(msg)
    }
    logger.info(json.dumps(log_entry))
```

é€‚åˆï¼šè°ƒè¯•ã€å®¡è®¡ã€å¯è§‚æµ‹æ€§ã€‚

---

## å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæœ‰æ—¶æ¶ˆæ¯çœ‹èµ·æ¥æ˜¯"æ‰¹é‡"è€Œä¸æ˜¯é€å­—æµå¼ï¼Ÿ**

SDK åœ¨å†…éƒ¨åšäº†ä¸€äº›å¤„ç†ã€‚ä½ æ”¶åˆ°çš„æ˜¯å·²èšåˆçš„æ¶ˆæ¯å—ã€‚çœŸæ­£çš„é€å­—èŠ‚æµå¼éœ€è¦æ›´åº•å±‚çš„ API æ§åˆ¶ã€‚

**Q: æ¶ˆæ¯é¡ºåºæ˜¯å¦ä¿è¯ï¼Ÿ**

æ˜¯çš„ã€‚SDK ä¿è¯æ¶ˆæ¯æŒ‰æ­£ç¡®é¡ºåºåˆ°è¾¾ã€‚

**Q: å¦‚ä½•åŒºåˆ†ä¸åŒçš„å›å¤è½®æ¬¡ï¼Ÿ**

æ¯æ¬¡ `query()` åçš„æ¶ˆæ¯æµæ˜¯ä¸€ä¸ªå®Œæ•´å›åˆï¼Œä»¥ `ResultMessage` ç»“æŸã€‚

**Q: SDK çš„å†å²ç®¡ç†æœ‰é•¿åº¦é™åˆ¶å—ï¼Ÿ**

SDK å†…éƒ¨ä¼šæ ¹æ®æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£è‡ªåŠ¨ç®¡ç†ã€‚å¦‚æœå¯¹è¯è¿‡é•¿ï¼Œå¯èƒ½ä¼šè§¦å‘è‡ªåŠ¨å‹ç¼©ã€‚

**Q: å¯ä»¥æ‰‹åŠ¨æ¸…é™¤å†å²å—ï¼Ÿ**

åˆ›å»ºæ–°çš„ `ClaudeSDKClient` å®ä¾‹å³å¯å¼€å§‹æ–°ä¼šè¯ã€‚

---

## å°ç»“

æµå¼è¾“å‡ºå’Œå¯¹è¯å†å²æ˜¯ Claude Agent SDK çš„ä¸¤ä¸ªæ ¸å¿ƒç‰¹æ€§ï¼š

**Streamingï¼ˆæµå¼è¾“å‡ºï¼‰**ï¼š
- å¼‚æ­¥æ¶ˆæ¯è¿­ä»£å™¨
- äº‹ä»¶é©±åŠ¨çš„å®æ—¶å¤„ç†
- è®©ä½ "çœ‹åˆ°" Agent çš„å·¥ä½œè¿‡ç¨‹

**Conversation Historyï¼ˆå¯¹è¯å†å²ï¼‰**ï¼š
- SDK è‡ªåŠ¨ç»´æŠ¤ä¸Šä¸‹æ–‡
- Stateful è®¾è®¡
- é›¶æ‰‹åŠ¨å†å²ç®¡ç†

**å…³é”®åŒºåˆ«**ï¼š
- Claude Agent SDK: Statefulï¼Œè‡ªåŠ¨ç®¡ç†å†å²
- Anthropic API: Statelessï¼Œéœ€è¦æ‰‹åŠ¨ä¼ é€’ `messages`

è¿™ä¸¤ä¸ªç‰¹æ€§çš„ç»„åˆï¼Œè®©æ„å»ºå¤šè½®äº¤äº’çš„ Agent åº”ç”¨å˜å¾—ç®€å•ç›´è§‚ã€‚

---

## ä¸‹ä¸€æ­¥

åœ¨ [04-Hookæœºåˆ¶è¯¦è§£](./04-Hookæœºåˆ¶è¯¦è§£.md) ä¸­ï¼Œæˆ‘ä»¬ä¼šå­¦ä¹ å¦‚ä½•åœ¨å·¥å…·è°ƒç”¨çš„å‰åæ’å…¥è‡ªå·±çš„é€»è¾‘â€”â€”æ‹¦æˆªã€è®°å½•ã€å®¡è®¡ã€‚

è¿™æ˜¯ä»"è®© Agent å·¥ä½œ"åˆ°"è®© Agent å¯æ§"çš„å…³é”®è½¬æŠ˜ã€‚
